.row.survey
  .col-md-8.col-md-offset-2
    div.welcome
      h4 #{@meeting.summary}
      p hosted by #{@meeting.organizer.email} #{time_ago_in_words @survey_invite.meeting_occurrence.start_time} ago.
    table.welcome
      tr
        td
          div.progress
            div.progress-bar role="progressbar" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100" style="width: 20%;" 1 / 6
        td
          div.welcome.back-link.centered
            i.fa.fa-backward.back-button id="back-button"
            span.back-esc esc

    = form_tag('/survey', class: 'form-questions', id: 'survey-form') do
      = hidden_field_tag :link_code, params[:link_code]
      - @questions.each_with_index do |question, i|
        = survey_tag(question[:question], question[:type], i + 1)

      /= submit_tag 'Send', id: "submit-button"

javascript:
  function set_why_color(label) {

    var why = label.closest(".question").find(".why");
    var continue_button = label.closest('.question').find('.button-block');
    why.slideDown(100, 'linear', function() {
      continue_button.show();
    });

    if (label.hasClass('btn-yes')) {
      why.addClass('yes');
      why.removeClass('no');
    } else {
      why.addClass('no');
      why.removeClass('yes');
    }
    why.focus();
  }

  function next_question_block() {
    var seen_visible_block = false;

    var list = $('.question');
    for(var i = 0; i < list.length; ++i) {
      var block = $(list[i]);

      if(block.is(':visible')) {
        seen_visible_block = true;
      } else if(seen_visible_block) {
        return (block);
      }
    }
  }

  function set_active_question(change_to_block) {
    if(typeof change_to_block != 'undefined') {
      var list = $('.question');
      $.each(list, function (index, this_block) {
        $(this_block).removeClass('on');
      });

      change_to_block.addClass('on');
      if ($('.on .general-feedback').length > 0) {
        $('.on .general-feedback').focus();
        $('.on .general-feedback').val('');
      }

      updateProgressBar(parseInt(change_to_block.attr('id').split('_')[1]));
    }
  }

  function updateProgressBar(step) {
    var percentage = parseInt(100 * (step / 6))
    $('.progress-bar').width(percentage+'%').attr('aria-valuenow', percentage).text(step+' / 6');
  }

  function keyboard_answer(key) {
    if($('.on .buttons').length == 1 && $('.on textarea').is(':focus') == false) {
      if(key == 'y') {
        $($('.on .buttons input:radio')[0]).trigger('click');
      } else if(key == 'n') {
        $($('.on .buttons input:radio')[1]).trigger('click');
      }
    }
  };

  $(document).ready(function () {
    $('.question input[type="radio"]').change(function () {
      var radio = $(this);
      $.each(radio.parents('.question').find('label'), function (i, v) {
        var label = $(v);
        if (label.children('input[type="radio"]:checked').length) {
          label.addClass('active');
          set_why_color(label);
          $('.on .text-input-legend').hide();
        } else {
          label.removeClass('active');
        }
      });
    });

    $('.btn-continue').click(function (e) {
      set_active_question(next_question_block());
    });

    $('.why').keydown(function (e) {
      if (e.shiftKey && e.keyCode == 13) {
        e.preventDefault();
        $('.on .btn-continue').trigger('click');
      }
    });

    $('.general-feedback').keydown(function (e) {
      if (e.shiftKey && e.keyCode == 13) {
        e.preventDefault();
        $('#submit').trigger('click');
      }
    });

    $('#submit').click(function (e) {
      $('#survey-form').submit();
    });

    $(document).keyup(function (e) {
      if (e.shiftKey && e.keyCode == 13) {
        e.preventDefault();
        keyboard_answer('enter');
      } else if (e.keyCode == 121 || e.keyCode == 89) {
        keyboard_answer('y');
      } else if (e.keyCode == 110 || e.keyCode == 78) {
        keyboard_answer('n');
      }
    });

    $(function () {
      $('textarea').autosize();
      $('#question_1').addClass('on');
    });
  });
